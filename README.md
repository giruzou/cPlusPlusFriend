# 君はC++クラスのフレンズなんだね

フレンズと言ったらC++でしょう。

```c++
class Train {
    // すごーい! シリアライザはクラスを永続化できるフレンズなんだね
    friend std::ostream& operator <<(std::ostream& os, const Train& train);
    friend std::istream& operator >>(std::istream& is, Train& train);
    friend boost::serialization::access;

    // ユニットテストはprivateメンバを読めるフレンズなんだね。たーのしー!
    FRIEND_TEST(TestSerialization, Initialize);
    FRIEND_TEST(TestSerialization, Std);
    FRIEND_TEST(TestSerialization, Boost);
    FRIEND_TEST(TestSerialization, Invalid);
};
```

[cppFriends.cpp](cppFriends.cpp)では、friend関数以外にも「フレンズなんだね」を連発していますが、まあ流行語ですし。そういう意味で、「すごいHaskellたのしく学ぼう!」という題の本は、時代の先を行っていたのですね。

アニメ「けものフレンズ」の主題歌「ようこそジャパリパークへ」を歌っているのは"どうぶつビスケッツ×PPP"ですが、PPPという単語から思い出すのは、Point-to-Point Protocolでも購買力平価説でもなく、アニメ「アイドルマスターシンデレラガールズ」に出てくる架空のファッションブランドPikaPikaPopだったりします。PikaPikaPopをPPPと略しているシーンはアニメにないはずですが、それ言ったら「フレンズなんだね」も本編になかったはずですし...

## やめるのだフェネック@C++

「やめるのだフェネック」あるいは「フェネックやめるのだ」がどこからきたのかよく分からないのですが、もしかして元ネタは[シェーン、おいやめろ！](http://labaq.com/archives/51829457.html)なのでしょうか。

1. やめるのだフェネック! enumを何でもintにキャストしてはいけないのだ! std::underlying_typeを使うのだ!
1. フェネックやめるのだ! XMMレジスタの値を、素のuint64_t[]に保存してはいけないのだ! 16 bytes アライ~~さん~~ンメントが必要なのだ!
1. (そろそろしつこいので以下同文) x64 ABIで、asmコードからCの関数を呼び出すときは、rspレジスタを16 bytes境界に合わせないといけないのだ! そうしないと、C++ライブラリの中で突然クラッシュすることがあるのだ!
1. x86-64で、intを一度に32ビット以上シフトするのはダメだ! REX.Wがないときのシフト回数は有効桁数が5ビットしかないのだ!
1. ```int64_t v = 1 << 32;``` はint64_tではなくintをシフトしているのだ! 0x100000000ではなく0が入るかもしれないのだ! int64_tの変数に代入してから<<=でシフトするんだ!
1. 配列をループで回すときのインデックスを何でもintにしてはいけないのだ! sizeof(size_t) > sizeof(int)だと4Gあたりで動作がおかしくなることがあるのだ!
1. 固定アドレスの格納先を、uint32_tとuint64_tとで、#ifdefで切り替えるのはやめるのだ! uintptr_tを使うのだ!
1. size_tのビット数が分からないからといって、printfの書式指定に%luと書くのはダメだ! %zuと書くのだ!
1. sizeofに型名を入れてはいけないのだ! 変数の型が変わった時オーバランするのだ! sizeof(*pObject)とすれば、ポインタpObjectが指すもののサイズが得られるのだ!
1. コメントに「この変数は符号なしのはず」とか書いてはいけないのだ! static_assert(std::is_unsigned)を書くのだ!
1. ```do { ... } while(--i >= 0); ```は、iが符号なし整数だと永久に終わらないのだ! プロセスの危機なのだ!
1. 非PODのオブジェクトをmemcpyしてはいけないのだ! memmoveもダメだ! vtableへのポインタもコピーされてしまうのだ! 派生クラスのメンバが切り捨てられて不定値に置き換わってしまうのだ!
1. memsetを使ってbyte単位以外の値でメモリを埋めるのは無理なのだ! std::fillを使うのだ!
1. 確かにC99の機能はC++でも使えるが、restrictはコンパイルエラーになることがあるのだ! 本当にrestrictが必要か考えるのだ!
1. 立っているビット数をfor文で数えるのは遅いのだ! コンパイラのマニュアルから __builtin_popcount とかを探すのだ!
1. strict aliasing rule警告の意味が分からないからって無視してはいけないのだ! [(参考)](http://dbp-consulting.com/tutorials/StrictAliasing.html) そもそもエンディアン変換なら、自作しないでntohlとかBoost.Endianとか探すのだ!
1. pragmaで警告を抑止してよいのは、コードレビューで承認されてからだ!
1. 2個のオブジェクトを交換するコードを自作してはいけないのだ! std::swapはno throw保証なのだ!
1. 何もしないデストラクタを{}と定義するのはダメだ! =defaultを使うのだ! 理由はEffective Modern C++ 項目17に書いてあるのだ!
1. ユニットテストが書きにくいからって、#defineでprivateをpublicに置き換えちゃいけないのだ! アクセス指定子を超えたメンバ変数の順序は入れ替わることがあるのだ!  [(参考)](http://en.cppreference.com/w/cpp/language/access) friendを使うのだ!
1. メンバ変数名の目印のアンダースコアは、名前の先頭につけちゃいけないのだ! _で始まり次が英大文字の名前はC++処理系の予約語なのだ!
1. 短絡評価の||を「または」と読まないのだ! 「さもなくば」と読むのだ! &&は「だったら」「なので」と読むのだ!
1. メンバ変数を増やしたとき、複数あるコンストラクタすべてに、そのメンバ変数の初期化を加えるのを忘れちゃいけないのだ! 可能ならメンバ変数の定義と併せて初期化して、それ以外の初期化方法だけコンストラクタに書けばよいのだ!
1. コードにstd::coutを直書きしてはいけないのだ! ユニットテストが書けないでないか! std::ostreamへの参照を渡すのだ! もちろんstd::cinもだ! ユニットテストでキー入力するのは大変なのだ!
1. コンテナの要素の型をソースコードにべた書きしたら、コンテナの型を変えた時に修正が大変なのだ! std::vector::value_type と auto と decltypeがあるじゃないか!
1. 配列の要素数を ```#define arraySizeof(a) (sizeof(a)/sizeof(a[0]))``` で数えるのはやめるのだ! aにポインタを渡すと、エラーにならずに変な値が返ってくるのだ! テンプレートとconstexprを使うのだ!
1. いくらマクロより関数テンプレートの方がいいからって、 ```#define WARN(str) printf("%s at %d", str, __LINE__)``` は関数にはできないのだ! WARNを呼び出した場所ではなく、WARNを定義した場所の行番号が表示されてしまうのだ!
1. 関数の動作を#ifdef SYM ... #endifで切り替えると、SYMをタイプミスしたときに...が除外されてしまうのだ! if (定数式)が使えるならそうするのだ! C++17ではif constexprが使える(かもしれない)のだ!
1. 関数の動作を何でもかんでもboolの引数で切り替えたら、呼び出す側のコードを読んでtrueとかfalseとか書いてあっても、何をしたいか分からなくなるのだ! enum classでパラメータに名前を付けるのだ!
1. タイピングが大変だからって、using namespace std;って書いちゃいけないのだ! boostと衝突したらどうするのだ! もうすぐC++17でstd::anyとstd::optionalがくるんだぞッ!
1. boost::anyオブジェクトにchar*型の値を入れたとき、 boost::any_cast<char *> ではなく boost::any_cast<const char *> で取り出すのはやめるのだ! boost::bad_any_castが飛んでくるぞ!
1. 空の構造体がたくさんあるからって、全部まとめて一つにするのはやめるのだ! それらはBoost.MultiIndexのタグなのだ!
1. ラムダ式の型をtypeid().name()で取得しようとするのは無駄なのだ! それはコンパイラが一意なものを決めるのだ!
1. 関数の返り値型をautoにしたら、return vec[i]でベクタの要素への参照は返せないのだ! 要素のコピーが値渡しされるのだ! そこはdecltype(auto)が必要なのだ!
1. そのreturn文の括弧は余計なのだ! 返り値がdecltype(auto)のときにreturn (v);すると、ローカル変数vへの参照を返すのだ! 未定義動作の危機なのだ!
1. volatile T*へのキャストをどう書く分からないからって、Cキャストを使っちゃいけないのだ! const_castを使うのだ!
1. constメンバ関数からメンバ変数を書き換えたくなったからといって、いきなりmutableとかconst_castとかしちゃいけないのだ! 呼び出し側はスレッドセーフを期待しているのだ!
1. boost/thread/future.hppなどをインクルードする.cppファイルで、Intel Syntaxのインラインアセンブリを使うと、アセンブラがエラーを出すことがあるぞ! Intel Syntaxでインラインアセンブリを記述するなら、その.cppファイルは他と分けた方がいいぞ!
1. CreateInstance()がいつでも生ポインタを返したら、誰がdeleteするかわからなくなって、メモリリークしたり二重解放したりするかもしれないのだ! deleteして欲しければ、std::unique_ptrを返すことを検討するのだ! 生ポインタは所有権を渡さないという意志なのだ!
1. ユニットテストを書くときは、いきなりテストを成功させてはいけないのだ! でないと、テストに成功したのか、そのテストを実行していないのか、区別がつかなくなるぞ! まずテストを実行して失敗することを確かめるのだ!

この語り口はあくまでネタなので、普段の私はもっと柔らかい口調で話しています、念のため。

## ライセンス

本レポジトリのライセンスは、[MITライセンス](LICENSE.txt)です。

ちなみに、けものフレンズ公式には[二次創作に関するガイドライン](http://kemono-friends.jp/)があります。私にはあいにく絵心がないです。
